<api xmlns="http://ws.apache.org/ns/synapse" context="/wso005/stream"
	name="YuccaDataInsertApi">
	<resource methods="POST" uri-template="/input/{codTenant}">
		<inSequence>
			<class name="org.csi.yucca.realtime.mediator.FormatValidMediator">
				<property name="variabileResult" value="isFormatValid" />
			</class>
			<filter source="get-property('isFormatValid')" regex="false">
				<then>
					<property name="HTTP_SC" value="500" scope="axis2" type="STRING"
						description="500HTTP" />


					<call-template target="YuccaDataservice_IsertApiErrorTMPL"
						description="">
						<with-param name="error_name" value="Json validation failed" />
						<with-param name="error_code" value="E012" />
						<with-param name="show_json" value="false" />
					</call-template>



					<respond />




				</then>
				<else></else>
			</filter>

			<property name="NO_ENTITY_BODY" scope="axis2" action="remove" />
			<property name="codiceTenant" expression="get-property('uri.var.codTenant')"
				scope="default" type="STRING" />
			<property name="JSONPayload" expression="json-eval($.)"
				scope="default" type="STRING" />
			<log level="custom">
				<property name="step" value="API_DataInsert_InsertRequesta BEGIN" />
			</log>
			<property name="bodyStream" expression="$body" scope="default"
				type="STRING" />




			<log level="custom">
				<property name="step"
					value="API_DataInsert_InsertRequesta DOPO PAYLOAD JS " />
			</log>


			<payloadFactory media-type="xml">
				<format>
					<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
						xmlns:dat="http://datainsert.yucca.csi.org">
						<soapenv:Body xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
							xmlns:dat="http://datainsert.yucca.csi.org">
							<dat:insertApi xmlns:dat="http://datainsert.yucca.csi.org">
								<dat:codTenant>$1</dat:codTenant>
								<dat:jsonData>$2
								</dat:jsonData>
							</dat:insertApi>
						</soapenv:Body>
					</soapenv:Envelope>
				</format>
				<args>
					<arg evaluator="xml" expression="get-property('codiceTenant')" />
					<arg evaluator="xml" expression="get-property('JSONPayload')" />
				</args>
			</payloadFactory>

			<log level="custom">
				<property name="step"
					value="API_DataInsert_InsertRequesta DOPO PAYLOAD med " />
				<property name="aaaaaaa" expression="get-property('REST_URL_POSTFIX')" />

			</log>


			<property name="messageType" value="text/xml" scope="axis2"
				type="STRING" />
			<property name="ContentType" value="text/xml" scope="axis2"
				type="STRING" />
			<property name="HTTP_METHOD" value="POST" scope="axis2"
				type="STRING" />

			<property name="REST_URL_POSTFIX" value="" scope="axis2"
				type="STRING" action="remove" />

			<property name="POST_TO_URI" value="true" scope="axis2"
				type="STRING" />

			<property name="FORCE_ERROR_ON_SOAP_FAULT" value="true"
				scope="default" type="STRING" />

			<callout
				serviceURL="https://sdnet-intapi.sdp.csi.it:453/wso005/services/InsertApi"
				action="insertApi">
				<source xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
					xmlns:org="http://org.csi.yucca" xpath="$body/child::*" />
				<target xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
					xmlns:org="http://org.csi.yucca" xpath="$body/child::*" />
			</callout>
			<log level="custom">
				<property name="step" value="API_DataInsert_InsertRequesta DOPO CALLOUT" />
			</log>


			<xslt xmlns:soapenv="http://www.w3.org/2003/05/soap-envelope"
				key="conf:xsl/XSLTInsertApiRemoveNameSpaces.xslt" source="$body" />

			<log level="custom">
				<property name="step"
					value="API_DataInsert_InsertRequesta DOPO trasformazione XSLT" />
			</log>

			<property xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
				name="insertException" expression="boolean($body/insertApiResponse/return/insertException/errorCode)"
				scope="default" type="STRING" />
			<filter source="get-property('insertException')" regex="false">
				<then>
					<log level="custom">
						<property name="step"
							value="API_DataInsert_InsertRequesta insertException NESSSSUNERRROREEE" />
						<property name="insertExceptionLOG" expression="get-property('insertException')" />
					</log>
				</then>
				<else>
					<property xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
						name="insertExceptionCode" expression="$body/insertApiResponse/return/insertException/errorCode"
						scope="default" type="STRING" />
					<property xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
						name="insertExceptionName" expression="$body/insertApiResponse/return/insertException/errorName"
						scope="default" type="STRING" />


					<log level="custom">
						<property name="step"
							value="API_DataInsert_InsertRequesta insertException ERRROREEEEEEEEEEEEEEEEEE SIIIIIIIIIIIIIIII" />
						<property name="insertExceptionLOG" expression="get-property('insertException')" />
					</log>
					
					
						<property name="HTTP_SC" value="500" scope="axis2" type="STRING"
							description="500HTTP" />


						<call-template target="YuccaDataservice_IsertApiErrorTMPL"
							description="">
							<with-param name="error_name" value="{get-property('insertExceptionName')}" />
							<with-param name="error_code" value="{get-property('insertExceptionCode')}" />
							<with-param name="show_json" value="true" />
						</call-template>



						<respond />
					
				</else>
			</filter>

			<property xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
				name="risposta" expression="$body"
				scope="default" type="STRING" />


			<property xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
				name="globalRequestId" expression="$body/insertApiResponse/return/globalRequestId"
				scope="default" type="STRING" />

			<log level="custom">
				<property name="globalRequestIdLOG" expression="get-property('globalRequestId')" />
			</log>


			<payloadFactory media-type="xml">
				<format>
					<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
						xmlns:dat="http://datainsert.yucca.csi.org">
						<soapenv:Body xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
							xmlns:dat="http://datainsert.yucca.csi.org">

							<dat:copyData xmlns:dat="http://datainsert.yucca.csi.org">
								<dat:codTenant>$1</dat:codTenant>
								<dat:globalIdRequest>$2</dat:globalIdRequest>
							</dat:copyData>

						</soapenv:Body>
					</soapenv:Envelope>
				</format>
				<args>
					<arg evaluator="xml" expression="get-property('codiceTenant')" />
					<arg evaluator="xml" expression="get-property('globalRequestId')" />
				</args>
			</payloadFactory>

			<log level="custom">
				<property name="step"
					value="API_DataInsert_InsertRequesta PRIMA DI COPY" />
			</log>


			<property name="SC_ACCEPTED" value="true" scope="axis2" />
			<property name="OUT_ONLY" value="true" scope="default" type="STRING" />
			<header name="Action" value="urn:copyData" />
			<clone continueParent="true" sequential="true">
				<target>
					<sequence>
						<log level="custom">
							<property name="step"
								value="API_DataInsert_InsertRequesta PRIMA DI COPY dentro clone" />
						</log>

						<send>
							<endpoint>
								<address
									uri="https://sdnet-intapi.sdp.csi.it:453/wso005/services/InsertApi"
									format="soap11" />
							</endpoint>
						</send>
					</sequence>
				</target>
			</clone>
			<property name="OUT_ONLY" value="false" scope="default"
				type="STRING" />
				
			<payloadFactory media-type="xml">
				<format>
					<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
						xmlns:dat="http://datainsert.yucca.csi.org">
						$1
					</soapenv:Envelope>
				</format>
				<args>
					<arg evaluator="xml" expression="get-property('risposta')" />
				</args>
			</payloadFactory>
				
				
			<loopback description="end" />



		</inSequence>
		<outSequence>
			<property name="messageType" value="application/json" scope="axis2"
				type="STRING" />
			<log level="custom">
				<property name="step" value="API_DataInsert_InsertRequesta END" />
			</log>
			<send />
		</outSequence>
		<faultSequence>

			<log level="custom">
				<property name="ERROR_MESSAGE" expression="get-property('ERROR_MESSAGE')" />
				<property name="ERROR_CODE" expression="get-property('ERROR_CODE')" />
				<property name="ERROR_DETAIL" expression="get-property('ERROR_DETAIL')" />
				<property name="globalRequestIdLOG" expression="get-property('ERROR_EXCEPTION      ')" />
			</log>



			<property name="HTTP_SC" value="500" scope="axis2" type="STRING"
				description="500HTTP" />
			<respond />

		</faultSequence>

	</resource>
	<handlers>
		<handler class="org.csi.yucca.realtime.authhandler.ISAuthenticationHandler">
			<property name="isServerUrl" value="https://int-sso.smartdatanet.it" />
			<property name="isAdminPassword" value="***REMOVED***" />
			<property name="isAdminUsername" value="admin" />
		</handler>
	</handlers>

</api>